on:
  workflow_dispatch:

name: Runner stats

jobs:
  runner-stats:
    name: Stats for ${{ matrix.runner }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        runner:
          - self-hosted-pi4-1
          - self-hosted-pi4-2
          - self-hosted-pi4-3
          - self-hosted-pi4-4
          - self-hosted-pi4-5
          - self-hosted-pi4-6
    steps:
      - name: System overview
        run: |
          echo "Kernel: $(uname -r)"
          echo "OS: $(cat /etc/os-release | grep PRETTY_NAME | cut -d'"' -f2)"
          echo "Architecture: $(uname -m)"
          echo ""

      - name: Uptime & load
        run: |
          uptime
          echo ""
          echo "Load averages (1, 5, 15 min):"
          cat /proc/loadavg
          echo ""

      - name: CPU info
        run: |
          echo "CPU Model: $(grep 'model name' /proc/cpuinfo | head -1 | cut -d':' -f2 | xargs || grep 'Model' /proc/cpuinfo | head -1 | cut -d':' -f2 | xargs)"
          echo "CPU Cores: $(nproc)"
          echo ""

      - name: Memory usage
        run: |
          free -h
          echo ""
          echo "Memory details:"
          echo "  Total: $(grep MemTotal /proc/meminfo | awk '{print $2/1024 " MB"}')"
          echo "  Available: $(grep MemAvailable /proc/meminfo | awk '{print $2/1024 " MB"}')"
          echo "  Swap Total: $(grep SwapTotal /proc/meminfo | awk '{print $2/1024 " MB"}')"
          echo "  Swap Free: $(grep SwapFree /proc/meminfo | awk '{print $2/1024 " MB"}')"
          echo ""

      - name: Disk usage
        run: |
          df -h
          echo ""
          echo "Disk usage summary for root filesystem:"
          df -h / | tail -1 | awk '{print "  Size: " $2 "\n  Used: " $3 " (" $5 ")\n  Available: " $4}'
          echo ""

      - name: SD card health
        run: |
          # Check if root is mounted read-only (sign of SD card failure)
          if grep -qs ' / .*\bro\b' /proc/mounts; then
            echo "⚠️  WARNING: Root filesystem is mounted READ-ONLY!"
          else
            echo "✅ Root filesystem is read-write"
          fi

          if touch /tmp/.sd_write_test_$$ 2>/dev/null && rm /tmp/.sd_write_test_$$ 2>/dev/null; then
            echo "✅ Write test passed"
          else
            echo "⚠️  WARNING: Write test failed!"
          fi

          io_errors=$(dmesg | tail -500 | grep -iE 'i/o error|mmc.*error|mmcblk.*error|failed|read-only|EXT4-fs error' | tail -10)
          if [ -n "$io_errors" ]; then
            echo "⚠️  Potential issues found:"
            echo "$io_errors"
          else
            echo "✅ No recent I/O or SD card errors detected"
          fi

          echo "SD Card Info"
          if [ -f /sys/block/mmcblk0/device/name ]; then
            echo " - Card name: $(cat /sys/block/mmcblk0/device/name)"
          fi
          if [ -f /sys/block/mmcblk0/device/type ]; then
            echo " - Card type: $(cat /sys/block/mmcblk0/device/type)"
          fi
          if [ -f /sys/block/mmcblk0/device/date ]; then
            echo " - Manufacture date: $(cat /sys/block/mmcblk0/device/date)"
          fi
          if [ -f /sys/block/mmcblk0/device/manfid ]; then
            manfid=$(cat /sys/block/mmcblk0/device/manfid)
            case "$manfid" in
              0x000001) manufacturer="Panasonic" ;;
              0x000002) manufacturer="Toshiba" ;;
              0x000003) manufacturer="SanDisk" ;;
              0x00001b) manufacturer="Samsung" ;;
              0x00001d) manufacturer="AData" ;;
              0x000027) manufacturer="Phison" ;;
              0x000028) manufacturer="Lexar" ;;
              0x000031) manufacturer="Silicon Power" ;;
              0x000041) manufacturer="Kingston" ;;
              0x000074) manufacturer="Transcend" ;;
              0x000082) manufacturer="Sony" ;;
              0x00009c) manufacturer="Angelbird" ;;
              0x0000fe) manufacturer="Micron" ;;
              *) manufacturer="Unknown ($manfid)" ;;
            esac
            echo " - Manufacturer: $manufacturer"
          fi
          if [ -f /sys/block/mmcblk0/size ]; then
            size_bytes=$(( $(cat /sys/block/mmcblk0/size) * 512 ))
            size_gb=$(awk "BEGIN {printf \"%.1f\", $size_bytes/1024/1024/1024}")
            echo " - Card size: ${size_gb} GB"
          fi
          echo ""

          echo "Inode Usage:"
          df -i / | tail -1 | awk '{print "  Used: " $3 "/" $2 " (" $5 ")"}'
          echo ""

      - name: Temperature
        run: |
          if [ -f /sys/class/thermal/thermal_zone0/temp ]; then
            temp=$(cat /sys/class/thermal/thermal_zone0/temp)
            echo "CPU Temperature: $(awk "BEGIN {printf \"%.1f\", $temp/1000}")°C"
          else
            echo "Temperature sensor not available"
          fi
          echo ""

      - name: Process info
        run: |
          echo "Running processes: $(ps aux | wc -l)"
          echo "Zombie processes: $(ps aux | awk '$8 ~ /Z/ {count++} END {print count+0}')"
          echo ""

      - name: GitHub Actions runner info
        run: |
          echo "Runner name: ${{ matrix.runner }}"
          echo "Runner OS: $RUNNER_OS"
          echo "Runner arch: $RUNNER_ARCH"
          echo ""

